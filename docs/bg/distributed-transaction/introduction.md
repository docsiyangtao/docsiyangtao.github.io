## 概念

在**分布式系统**中，事务参与者在不同的分布式节点（产生了不同的会话，每个会话的事务都是隔离的）或事务操作不同的数据源，这些情况产生的事务都叫分布式事务。

（注意：如果事务在同一个节点上，那就没有必要使用分布式事务了，可以通过异常的传递机制实现事务的同时回滚，如果没有异常就做事务的提交，这种成为**本地事务**）

## 解决方案

1. 两段提交

   分两个阶段

   1. 准备。所有的节点（事务参与者）执行事务操作，执行完成以后想管理者提交报告
   2. 提交。管理者确认所有的节点都执行完成以后，向所有参与者发送提交指令

2. 消息事务

   基于消息中间件的两段提交，保证本地操作以及对外发送消息同时成功，各节点基于消息来判断是否触发回滚接口回滚事务

分布式事务还可以划分控制力度，如不控制（不引入分布式事务）、部分控制（消息事务，只控制部分节点参与事务，如Try Confirm Cancel）以及完全控制（两段提交，控制所有节点）。实际使用中需要根据业务场景去判断使用控制力度，因为完全控制是在牺牲部分性能的前提下保障的一致性。

## 常用框架

1. TX-LCN。基于SpringBoot，使用简单，对代码几乎零侵入
2. Seata。软事务，常用语SpringCloud Alibaba。

使用框架的好处是封装了各种方法，调用时只需调用对应注解，或者如TCC模式中只需要写对应的try、confirm、cancel方法即可。

## 理论依据

两大理论依据：CAP、BASE

1. CAP定理

   * 一致性（Consistency）：分布式系统中所有节点的状态都是一致的
   * 可用性（Availability）：集群的一部分节点出现故障后，整个集群能否响应客户端请求
   * 分区容错性（Partition tolerance）：分区相当于对操作的时限有限制，如果系统在一定时限内不能达到数据一致性，则意味着发生了分区

   CA方案：单体应用，DB都是同一个

   CP方案：主从架构，当Master宕机以后可能会出现一段时间的系统不可用

   AP方案（主流）：考虑的是最终一致性，可能会出现事务管理的延迟以及数据最终状态的延迟。各节点执行各自的操作，只要有任何一个节点操作失败了，则不进行提交操作，统一进行回滚，这叫事务的最终确认的延迟；各节点需要记录自己新增、修改、删除的数据，在所有操作完成后互相通信确认无异常后再进行提交，如有异常则需要进行回滚操作（删除新增、恢复修改或已删除的数据等），这叫数据最终确认的延迟。

2. BASE理论

   对CAP定理的延伸，是对C和A的权衡，无法做到强一致则做到最终一致

   * 基本可用（Basically Available）：分布式系统遇到故障的时候，允许损失部分可用性。如增加响应时间，访问量激增时引导部分用户到降级页面
   * 软状态（Soft state）：指数据允许存在中间状态，但这个状态不能是影响系统可用性的，即允许分布式节点之间存在同步延迟。如锁定某个库存的操作，用户可看到有剩余库存，但想锁定库存时不一定可以锁定成功
   * 最终一致性（Eventually consistent）：允许经过一定时间后才能达到整个系统的一致性。强一致性要求整个系统都达到了一致性才会响应，而最终一致性就可以看做是弱一致性，响应给用户的时候整个系统可能没有达到一致性， 但最终一定会达到一致性效果

