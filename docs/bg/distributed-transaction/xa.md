## XA协议

XA协议由Oracle Tuxedo提出，交给X/Open组织，作为资源管理器（数据库）与事务管理器的接口标准。目前，Oracle、infomix、DB2等各大数据库都提供对XA的支持。XA协议采用两阶段提交方式来管理分布式事务。XA接口提供资源管理器与事务管理器之间进行通信的标准接口。

XA就是X/Open DTP定义的交易中间件与数据库之间的接口规范（接口函数），交易中间件用它来通知数据库的开始、结束以及提交、回滚等。XA接口函数由数据库厂商提供。

X/Open组织（Open Group）定义了分布式事务处理模型。X/Open DTP模型包括应用程序（AP）、事务管理器（TM）、资源管理器（RM）、通信资源管理器（CRM）四部分。一般常见的事务管理器（TM）是交易中间件，常见的资源管理器（RM）是数据库，常见的通信资源管理器（CRM）是消息中间件。

XA协议常用于银行、保险、医疗等使用国际标准、长事务的开发领域，并不常见于互联网领域。

## 一阶段提交

<img src="https://picgo-1304850123.cos.ap-guangzhou.myqcloud.com/image-20230321074818330.png" alt="image-20230321074818330" style="zoom:50%;" />

如果在程序中开启了事务，那么在应用程序发出提交/回滚请求后，数据库执行操作，而后将成功/失败返回给应用程序，程序继续执行。

## 二阶段提交

<img src="https://picgo-1304850123.cos.ap-guangzhou.myqcloud.com/image-20230321075022935.png" alt="image-20230321075022935" style="zoom:50%;" />

二阶段协议通过将两层变为三层，增加了中间的管理者角色，从而协调多个数据源，二阶段提交协议分为两个阶段

### 第一阶段

<img src="https://picgo-1304850123.cos.ap-guangzhou.myqcloud.com/image-20230321075251881.png" alt="image-20230321075251881" style="zoom:50%;" />

应用程序调用了事务管理器的提交方法，分为两个步骤：

1. 事务管理器通知参与该事务的各个资源管理器，通知他们开始准备事务
2. 资源管理器接收到消息后开始准备阶段，写好事务日志并执行事务，但不提交，然后将是否就绪的消息返回给事务管理器（此时已经将事务的大部分事情做完，以后的内容耗时极小）

### 第二阶段

<img src="https://picgo-1304850123.cos.ap-guangzhou.myqcloud.com/image-20230321075647107.png" alt="image-20230321075647107" style="zoom:50%;" />

事务管理器收到所有资源管理器的就绪信息后，协调提交事务，分为两个步骤：

1. 事务管理器通知参与该事务的各个资源管理器，通知他们提交事务
2. 资源管理器接收到消息后开始提交，并将提交结果返回给事务管理器（极快）

## 缺点

二阶段提交的第一阶段可能导致阻塞。DB不一定能及时响应就绪信息，整体的两阶段提交对于AP来说是不友好的，事务管理对于AP来说是阻塞的，TM与DB之间的预备、就绪通信也是阻塞的。

可以通过MQ监听来实现异步，引入超时机制来解决TM与DB之间的阻塞问题，但一般也不用此类CRM通讯资源管理器在XA协议中使用较少，因为会增加等待消息的时间降低系统的吞吐量。